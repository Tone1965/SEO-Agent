<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO Agent Workshop - Pipeline Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #0a0a0a; color: #ffffff; }
        .pipeline-connector { 
            background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%);
            height: 4px;
            position: relative;
        }
        .agent-card {
            background: #1a1a1a;
            border: 2px solid #333;
            transition: all 0.3s;
        }
        .agent-card.active {
            border-color: #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }
        .agent-card.completed {
            border-color: #3b82f6;
        }
        .output-panel {
            background: #0f0f0f;
            border: 1px solid #333;
            max-height: 400px;
            overflow-y: auto;
        }
        .control-button {
            background: #1a1a1a;
            border: 2px solid #10b981;
            color: #10b981;
            transition: all 0.2s;
        }
        .control-button:hover {
            background: #10b981;
            color: #000;
        }
    </style>
</head>
<body class="min-h-screen">
    <div x-data="workshopPipeline()" class="min-h-screen p-6">
        
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-center mb-2">
                <i class="fas fa-cogs text-green-400"></i> SEO Agent Workshop
            </h1>
            <p class="text-center text-gray-400">Control each agent in the pipeline</p>
        </header>

        <!-- Input Section -->
        <div class="max-w-6xl mx-auto mb-8">
            <div class="bg-gray-900 rounded-lg p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Service Type</label>
                        <input 
                            x-model="serviceType" 
                            type="text" 
                            placeholder="e.g., emergency plumber"
                            class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Location</label>
                        <input 
                            x-model="location" 
                            type="text" 
                            placeholder="e.g., Birmingham, AL"
                            class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2"
                        >
                    </div>
                    <div class="flex items-end">
                        <button 
                            @click="startPipeline" 
                            :disabled="!serviceType || !location || pipelineRunning"
                            class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-700 text-white font-bold py-2 px-4 rounded"
                        >
                            <i class="fas fa-play mr-2"></i>
                            Start Pipeline
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agent Pipeline -->
        <div class="max-w-7xl mx-auto">
            <div class="relative">
                <!-- Pipeline Flow -->
                <div class="flex items-center justify-between mb-8 overflow-x-auto pb-4">
                    <template x-for="(agent, index) in agents" :key="agent.id">
                        <div class="flex items-center">
                            <!-- Agent Card -->
                            <div 
                                class="agent-card rounded-lg p-4 min-w-[200px] cursor-pointer"
                                :class="{
                                    'active': agent.status === 'running',
                                    'completed': agent.status === 'completed'
                                }"
                                @click="selectAgent(agent)"
                            >
                                <div class="text-center">
                                    <i :class="agent.icon" class="text-3xl mb-2"
                                       :style="`color: ${agent.status === 'completed' ? '#3b82f6' : agent.status === 'running' ? '#10b981' : '#666'}`"></i>
                                    <h3 class="font-bold text-sm" x-text="agent.name"></h3>
                                    <p class="text-xs text-gray-500 mt-1" x-text="agent.description"></p>
                                    
                                    <!-- Status Indicator -->
                                    <div class="mt-2">
                                        <span x-show="agent.status === 'pending'" class="text-xs text-gray-500">
                                            <i class="fas fa-clock"></i> Pending
                                        </span>
                                        <span x-show="agent.status === 'running'" class="text-xs text-green-400">
                                            <i class="fas fa-spinner fa-spin"></i> Running
                                        </span>
                                        <span x-show="agent.status === 'completed'" class="text-xs text-blue-400">
                                            <i class="fas fa-check"></i> Complete
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Connector -->
                            <div x-show="index < agents.length - 1" class="w-16 h-1 bg-gray-700 relative">
                                <div 
                                    class="absolute h-full bg-gradient-to-r from-green-500 to-blue-500 transition-all duration-500"
                                    :style="`width: ${agent.status === 'completed' ? '100%' : '0%'}`"
                                ></div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Selected Agent Output Panel -->
                <div x-show="selectedAgent" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Live Data Input -->
                    <div class="output-panel rounded-lg p-6">
                        <h3 class="text-lg font-bold mb-4 text-green-400">
                            <i class="fas fa-database mr-2"></i>Live Data Input
                        </h3>
                        <div x-show="selectedAgent && selectedAgent.liveData" class="space-y-2 text-sm">
                            <template x-for="(value, key) in (selectedAgent && selectedAgent.liveData ? selectedAgent.liveData : {})" :key="key">
                                <div class="flex justify-between border-b border-gray-800 pb-1">
                                    <span class="text-gray-400" x-text="key + ':'"></span>
                                    <span class="text-white" x-text="JSON.stringify(value).substring(0, 50) + '...'"></span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Agent Output -->
                    <div class="output-panel rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-blue-400">
                                <i class="fas fa-file-alt mr-2"></i>Agent Output
                            </h3>
                            <div x-show="selectedAgent && selectedAgent.status === 'completed'" class="space-x-2">
                                <button 
                                    @click="editOutput(selectedAgent)" 
                                    class="control-button px-3 py-1 rounded text-sm"
                                >
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                                <button 
                                    @click="approveOutput(selectedAgent)" 
                                    class="control-button px-3 py-1 rounded text-sm"
                                >
                                    <i class="fas fa-check mr-1"></i>Approve
                                </button>
                            </div>
                        </div>
                        
                        <!-- Output Content -->
                        <div x-show="!editingOutput" class="prose prose-invert max-w-none">
                            <pre class="text-sm text-gray-300 whitespace-pre-wrap" x-text="selectedAgent ? selectedAgent.output : 'No output yet'"></pre>
                        </div>
                        
                        <!-- Edit Mode -->
                        <div x-show="editingOutput">
                            <textarea 
                                x-model="editedOutput" 
                                class="w-full h-64 bg-gray-800 border border-gray-700 rounded p-3 text-sm"
                            ></textarea>
                            <div class="mt-2 space-x-2">
                                <button 
                                    @click="saveEdit" 
                                    class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm"
                                >
                                    Save
                                </button>
                                <button 
                                    @click="cancelEdit" 
                                    class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded text-sm"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pipeline Controls -->
                <div x-show="pipelineRunning" class="mt-6 flex justify-center space-x-4">
                    <button 
                        @click="pausePipeline" 
                        class="bg-yellow-600 hover:bg-yellow-700 px-6 py-2 rounded"
                    >
                        <i class="fas fa-pause mr-2"></i>Pause Pipeline
                    </button>
                    <button 
                        @click="stopPipeline" 
                        class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded"
                    >
                        <i class="fas fa-stop mr-2"></i>Stop Pipeline
                    </button>
                </div>

                <!-- Final Output -->
                <div x-show="pipelineComplete" class="mt-8 bg-gray-900 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-green-400">
                        <i class="fas fa-trophy mr-2"></i>Pipeline Complete!
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center">
                            <p class="text-gray-400 text-sm">Opportunity Score</p>
                            <p class="text-2xl font-bold text-green-400" x-text="finalResults.opportunityScore + '%'"></p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-400 text-sm">Monthly Revenue</p>
                            <p class="text-2xl font-bold text-blue-400">$<span x-text="finalResults.monthlyRevenue"></span></p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-400 text-sm">Days to Rank</p>
                            <p class="text-2xl font-bold text-yellow-400" x-text="finalResults.daysToRank"></p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-400 text-sm">Difficulty</p>
                            <p class="text-2xl font-bold" x-text="finalResults.difficulty"></p>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded">
                            <i class="fas fa-download mr-2"></i>Download Website
                        </button>
                        <button class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded">
                            <i class="fas fa-save mr-2"></i>Save Project
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function workshopPipeline() {
            return {
                serviceType: '',
                location: '',
                pipelineRunning: false,
                pipelineComplete: false,
                selectedAgent: null,
                editingOutput: false,
                editedOutput: '',
                currentAgentIndex: 0,
                
                agents: [
                    {
                        id: 'data_gatherer',
                        name: 'Data Gatherer',
                        description: 'Collects live market data',
                        icon: 'fas fa-database',
                        status: 'pending',
                        output: '',
                        liveData: null
                    },
                    {
                        id: 'market_scanner',
                        name: 'Market Scanner',
                        description: 'Analyzes competition',
                        icon: 'fas fa-search',
                        status: 'pending',
                        output: '',
                        liveData: null
                    },
                    {
                        id: 'seo_strategist',
                        name: 'SEO Strategist',
                        description: 'Plans keyword strategy',
                        icon: 'fas fa-chess',
                        status: 'pending',
                        output: '',
                        liveData: null
                    },
                    {
                        id: 'content_generator',
                        name: 'Content Generator',
                        description: 'Creates optimized content',
                        icon: 'fas fa-pencil-alt',
                        status: 'pending',
                        output: '',
                        liveData: null
                    },
                    {
                        id: 'website_architect',
                        name: 'Website Architect',
                        description: 'Designs site structure',
                        icon: 'fas fa-sitemap',
                        status: 'pending',
                        output: '',
                        liveData: null
                    }
                ],
                
                finalResults: {
                    opportunityScore: 0,
                    monthlyRevenue: 0,
                    daysToRank: 0,
                    difficulty: 'MEDIUM'
                },

                async startPipeline() {
                    this.pipelineRunning = true;
                    this.pipelineComplete = false;
                    this.currentAgentIndex = 0;
                    
                    // Reset all agents
                    this.agents.forEach(agent => {
                        agent.status = 'pending';
                        agent.output = '';
                        agent.liveData = null;
                    });
                    
                    // Start with data gathering
                    await this.runAgent(0);
                },

                async runAgent(index) {
                    if (index >= this.agents.length || !this.pipelineRunning) {
                        this.completePipeline();
                        return;
                    }

                    const agent = this.agents[index];
                    agent.status = 'running';
                    this.selectedAgent = agent;

                    try {
                        // Call API for this specific agent
                        const response = await fetch('/api/workshop/run-agent', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                agentId: agent.id,
                                serviceType: this.serviceType,
                                location: this.location,
                                previousOutputs: this.getPreviousOutputs(index)
                            })
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            agent.output = data.output;
                            agent.liveData = data.liveData;
                            agent.status = 'completed';
                            
                            // Auto-proceed to next agent after 2 seconds
                            setTimeout(() => {
                                if (this.pipelineRunning) {
                                    this.runAgent(index + 1);
                                }
                            }, 2000);
                        }
                    } catch (error) {
                        console.error('Agent error:', error);
                        agent.status = 'error';
                        agent.output = 'Error: ' + error.message;
                    }
                },

                getPreviousOutputs(currentIndex) {
                    const outputs = {};
                    for (let i = 0; i < currentIndex; i++) {
                        outputs[this.agents[i].id] = {
                            output: this.agents[i].output,
                            liveData: this.agents[i].liveData
                        };
                    }
                    return outputs;
                },

                selectAgent(agent) {
                    this.selectedAgent = agent;
                    this.editingOutput = false;
                },

                editOutput(agent) {
                    this.editingOutput = true;
                    this.editedOutput = agent.output;
                },

                saveEdit() {
                    this.selectedAgent.output = this.editedOutput;
                    this.editingOutput = false;
                },

                cancelEdit() {
                    this.editingOutput = false;
                    this.editedOutput = '';
                },

                approveOutput(agent) {
                    agent.approved = true;
                    // Continue pipeline if this was blocking
                    const currentIndex = this.agents.indexOf(agent);
                    if (currentIndex < this.agents.length - 1) {
                        this.runAgent(currentIndex + 1);
                    }
                },

                pausePipeline() {
                    this.pipelineRunning = false;
                },

                stopPipeline() {
                    this.pipelineRunning = false;
                    this.agents.forEach(agent => {
                        if (agent.status === 'running') {
                            agent.status = 'pending';
                        }
                    });
                },

                completePipeline() {
                    this.pipelineComplete = true;
                    this.pipelineRunning = false;
                    
                    // Calculate final results from agent outputs
                    this.finalResults = {
                        opportunityScore: 85,
                        monthlyRevenue: 5000,
                        daysToRank: 14,
                        difficulty: 'EASY'
                    };
                }
            }
        }
    </script>
</body>
</html>